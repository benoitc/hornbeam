---
import BaseLayout from './BaseLayout.astro';
import { getCollection } from 'astro:content';

interface Props {
  title: string;
  description?: string;
}

const { title, description } = Astro.props;

const allDocs = await getCollection('docs');

// Group docs by category
const categorize = (slug: string) => {
  if (slug.startsWith('erlang-python/')) return 'erlang-python';
  if (slug.startsWith('guides/')) return 'guides';
  if (slug.startsWith('examples/')) return 'examples';
  if (slug.startsWith('reference/')) return 'reference';
  return 'main';
};

const mainDocs = allDocs
  .filter(d => categorize(d.slug) === 'main')
  .sort((a, b) => (a.data.order || 99) - (b.data.order || 99));

const guideDocs = allDocs
  .filter(d => categorize(d.slug) === 'guides')
  .sort((a, b) => (a.data.order || 99) - (b.data.order || 99));

const exampleDocs = allDocs
  .filter(d => categorize(d.slug) === 'examples')
  .sort((a, b) => (a.data.order || 99) - (b.data.order || 99));

const referenceDocs = allDocs
  .filter(d => categorize(d.slug) === 'reference')
  .sort((a, b) => (a.data.order || 99) - (b.data.order || 99));

const erlangPythonDocs = allDocs
  .filter(d => categorize(d.slug) === 'erlang-python')
  .sort((a, b) => (a.data.order || 99) - (b.data.order || 99));

const currentPath = Astro.url.pathname;

// Determine which product section we're in
const isErlangPythonSection = currentPath.includes('/erlang-python');
---

<BaseLayout title={title} description={description}>
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <div class="flex flex-col md:flex-row gap-8">
      <!-- Sidebar -->
      <aside class="md:w-56 flex-shrink-0">
        <nav class="md:sticky md:top-20 space-y-6">

          <!-- Product Switcher -->
          <div class="flex gap-2 p-1 bg-hb-green-dark/20 rounded-lg">
            <a
              href="/docs"
              class:list={[
                "flex-1 text-center text-xs py-2 px-3 rounded-md transition font-medium",
                !isErlangPythonSection
                  ? "bg-hb-green text-white"
                  : "text-hb-gray/60 hover:text-hb-gray"
              ]}
            >
              Hornbeam
            </a>
            <a
              href="/docs/erlang-python/getting-started"
              class:list={[
                "flex-1 text-center text-xs py-2 px-3 rounded-md transition font-medium",
                isErlangPythonSection
                  ? "bg-hb-erlang text-white"
                  : "text-hb-gray/60 hover:text-hb-gray"
              ]}
            >
              Erlang Python
            </a>
          </div>

          {!isErlangPythonSection ? (
            <>
              <!-- Hornbeam Docs -->
              <div>
                <h3 class="font-semibold text-hb-gray mb-3 text-xs uppercase tracking-wider">Getting Started</h3>
                <ul class="space-y-1">
                  {mainDocs.map((doc) => (
                    <li>
                      <a
                        href={doc.slug === 'index' ? '/docs' : `/docs/${doc.slug}`}
                        class:list={[
                          "block text-sm py-1.5 px-2 rounded transition",
                          currentPath === (doc.slug === 'index' ? '/docs' : `/docs/${doc.slug}`) || currentPath === (doc.slug === 'index' ? '/docs/' : `/docs/${doc.slug}/`)
                            ? "text-hb-green-light bg-hb-green-dark/20"
                            : "text-hb-gray/60 hover:text-hb-green-light hover:bg-hb-green-dark/10"
                        ]}
                      >
                        {doc.data.title}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>

              {guideDocs.length > 0 && (
                <div>
                  <h3 class="font-semibold text-hb-gray mb-3 text-xs uppercase tracking-wider">Guides</h3>
                  <ul class="space-y-1">
                    {guideDocs.map((doc) => (
                      <li>
                        <a
                          href={`/docs/${doc.slug}`}
                          class:list={[
                            "block text-sm py-1.5 px-2 rounded transition",
                            currentPath === `/docs/${doc.slug}` || currentPath === `/docs/${doc.slug}/`
                              ? "text-hb-green-light bg-hb-green-dark/20"
                              : "text-hb-gray/60 hover:text-hb-green-light hover:bg-hb-green-dark/10"
                          ]}
                        >
                          {doc.data.title}
                        </a>
                      </li>
                    ))}
                  </ul>
                </div>
              )}

              {exampleDocs.length > 0 && (
                <div>
                  <h3 class="font-semibold text-hb-gray mb-3 text-xs uppercase tracking-wider">Examples</h3>
                  <ul class="space-y-1">
                    {exampleDocs.map((doc) => (
                      <li>
                        <a
                          href={`/docs/${doc.slug}`}
                          class:list={[
                            "block text-sm py-1.5 px-2 rounded transition",
                            currentPath === `/docs/${doc.slug}` || currentPath === `/docs/${doc.slug}/`
                              ? "text-hb-green-light bg-hb-green-dark/20"
                              : "text-hb-gray/60 hover:text-hb-green-light hover:bg-hb-green-dark/10"
                          ]}
                        >
                          {doc.data.title}
                        </a>
                      </li>
                    ))}
                  </ul>
                </div>
              )}

              {referenceDocs.length > 0 && (
                <div>
                  <h3 class="font-semibold text-hb-gray mb-3 text-xs uppercase tracking-wider">Reference</h3>
                  <ul class="space-y-1">
                    {referenceDocs.map((doc) => (
                      <li>
                        <a
                          href={`/docs/${doc.slug}`}
                          class:list={[
                            "block text-sm py-1.5 px-2 rounded transition",
                            currentPath === `/docs/${doc.slug}` || currentPath === `/docs/${doc.slug}/`
                              ? "text-hb-green-light bg-hb-green-dark/20"
                              : "text-hb-gray/60 hover:text-hb-green-light hover:bg-hb-green-dark/10"
                          ]}
                        >
                          {doc.data.title}
                        </a>
                      </li>
                    ))}
                  </ul>
                </div>
              )}
            </>
          ) : (
            <>
              <!-- Erlang Python Docs -->
              <div>
                <h3 class="font-semibold text-hb-gray mb-3 text-xs uppercase tracking-wider">Erlang Python</h3>
                <ul class="space-y-1">
                  {erlangPythonDocs.map((doc) => (
                    <li>
                      <a
                        href={`/docs/${doc.slug}`}
                        class:list={[
                          "block text-sm py-1.5 px-2 rounded transition",
                          currentPath === `/docs/${doc.slug}` || currentPath === `/docs/${doc.slug}/`
                            ? "text-hb-green-light bg-hb-green-dark/20"
                            : "text-hb-gray/60 hover:text-hb-green-light hover:bg-hb-green-dark/10"
                        ]}
                      >
                        {doc.data.title}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>

              <!-- Link to hex.pm for API reference -->
              <div>
                <h3 class="font-semibold text-hb-gray mb-3 text-xs uppercase tracking-wider">API Reference</h3>
                <ul class="space-y-1">
                  <li>
                    <a
                      href="https://hexdocs.pm/erlang_python"
                      target="_blank"
                      rel="noopener noreferrer"
                      class="block text-sm py-1.5 px-2 rounded transition text-hb-gray/60 hover:text-hb-green-light hover:bg-hb-green-dark/10 flex items-center gap-1"
                    >
                      Module Docs (hex.pm)
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                      </svg>
                    </a>
                  </li>
                </ul>
              </div>
            </>
          )}
        </nav>
      </aside>

      <!-- Main content -->
      <main class="flex-1 min-w-0">
        <article class="prose prose-invert prose-headings:text-hb-gray prose-p:text-hb-gray/80 prose-a:text-hb-green-light prose-a:no-underline hover:prose-a:underline prose-code:text-hb-green-light prose-code:bg-hb-green-dark/20 prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-pre:bg-hb-black prose-pre:border prose-pre:border-hb-green-dark/30 prose-strong:text-hb-gray prose-table:text-hb-gray/80 prose-th:text-hb-gray prose-td:border-hb-green-dark/30 prose-th:border-hb-green-dark/30 max-w-none">
          <slot />
        </article>
      </main>
    </div>
  </div>
</BaseLayout>
